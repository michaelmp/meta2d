=begin
  A basic build script for meta2d.js.

  How to use this build script:
    (1) Install rake for your system.
    (2) Run `rake' in your terminal.
    (3) All builds are output to `build' directory.

=end

directory "build"
directory "doc/api"
directory "jsmin/bin"

# Order matters:
sourcefiles = [
  "src/meta2d.js",
  "src/modify.js",
  "src/math/affine.js",
  "src/math/rect.js",
  "src/math/vector.js",
  "src/animation.js",
  "src/mask.js",
  "src/context.js",
  "src/image.js",
  "src/layer.js",
  "src/lru.js",
  "src/metacontext.js",
  "src/process.js",
  "src/projection.js",
  "src/rcache.js",
  "src/rtree.js",
  "src/segment.js",
  "src/tween.js"
]

signature = %{"/**\n * meta2d.js (c) 2011 Michael Morris-Pearce\n * visit https://gitorious.org/meta2d/ for more information. */"}

desc "Combine all javascript source files into a single file."
task :merge => 'build' do
  puts "Merging src/*.js into build/meta2d.js"
  sh "cat " + sourcefiles.join(" ") + " > 'build/meta2d.js'"
  puts "Done merging source."
  puts ""
end

desc "Build the jsmin binary."
file 'jsmin/bin/jsmin' => ['jsmin/src/jsmin.c', 'jsmin/bin'] do
  puts "Building jsmin from source..."
  sh "gcc jsmin/src/jsmin.c -o jsmin/bin/jsmin"
  puts "Done building jsmin."
  puts ""
end

desc "Minify the javascript source."
task :minify => ['jsmin/bin/jsmin'] do
  puts "Minifying build/meta2d.js as build/meta2d.min.js..."
  sh "echo " + signature + " > 'build/meta2d.min.js'"
  sh "'jsmin/bin/jsmin' < 'build/meta2d.js' >> 'build/meta2d.min.js'" 
  puts "Done minifying."
  puts ""
end

desc "Export a gzip-compressed copy of all builds."
task :compress => [:merge, :minify] do
  puts "gzipping build files..."
  sh "gzip -c build/meta2d.js > build/meta2d.js.gz"
  sh "gzip -c build/meta2d.min.js > build/meta2d.min.js.gz"
  puts "Done compressing."
  puts ""
end

desc "Build the documentation."
task :document => [:merge, 'doc/api'] do
  puts "Parsing comments to build HTML documentation..."
  sh "cat 'build/meta2d.js' | ./doc.py > doc/api/index.html"
  puts "Done documenting."
  puts ""
end

desc "Remove all generated files."
task :clean do
  sh """
    rm -r build ;
    rm doc/api/index.html ;
    rm -r jsmin/bin ;
    rm *~ ;
    rm src/*~ ;
    rm src/math/*~ ;
    rm doc/api/*~ ;
    rm test/*~ ;
    rm demo/*~
    """
end

desc "Merge, minify, and compress source code."
task :default => [:merge, :minify, :compress] do
end
